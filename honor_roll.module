<?php

/**
 * @file
 * 
 * Create the Honor Role.
 */

/* CSV class for reading CSV */
require_once ( dirname(__FILE__) . '/classes/HonorRollCSV.php');

/**
 * Implements hook_block_info().
 *
 * @return associative array
 */
function honor_roll_block_info()
{
    // Graduate block
    $blocks['honor_roll_graduates'] = array(
        'info' => t('Honor Roll Graduates'),
        'cache' => DRUPAL_CACHE_PER_ROLE,
        'region' => 'Content',
        'visibility' => BLOCK_VISIBILITY_LISTED,
        'pages' => 'node/*'
    );

    // Undergraduate block
    $blocks['honor_roll_undergraduates'] = array(
        'info' => t('Honor Roll Undergraduates'),
        'cache' => DRUPAL_CACHE_PER_ROLE,
        'region' => 'Content',
        'visibility' => BLOCK_VISIBILITY_LISTED,
        'pages' => 'node/*'
    );
    return $blocks;
}

/**
 * Implements hook_admin().
 *
 * Creates the text input field for the settings page. Specifically the
 * area where the file path to the CSV file which contains the honor roll
 * data. This file will be read once a day and its contents will be cached.
 * 
 * @return array Settings form elements.
 */
function honor_roll_admin()
{
    $form = array();
    $currentPath = getcwd();

    // Graduate setting
    $form['honor_roll_graduate_csv_file_path'] = array(
        '#type' => 'textfield',
        '#title' => t('CSV File Path'),
        '#default_value' => variable_get('honor_roll_graduate_csv_file_path'),
        '#size' => 50,
        '#maxlength' => 200,
        '#description' => "The file path to the CSV file containing the graduate honor roll data.<br>This file is read once a day and the contents cached.<br><br>"."Example: ".$currentPath."/example.csv",
        '#required' => true,
    );

    // Undergraduate setting
    $form['honor_roll_undergraduate_csv_file_path'] = array(
        '#type' => 'textfield',
        '#title' => t('CSV File Path'),
        '#default_value' => variable_get('honor_roll_undergraduate_csv_file_path'),
        '#size' => 50,
        '#maxlength' => 200,
        '#description' => "The file path to the CSV file containing the undergraduate honor roll data.<br>This file is read once a day and the contents cached.<br><br>"."Example: ".$currentPath."/example.csv",
        '#required' => true,
    );
    return system_settings_form($form);
}

/**
 * Implements hook_menu()
 * 
 * @return array
 */
function honor_roll_menu()
{
    $items = array();
    $items['admin/settings/honor_roll'] = array(
        'title' => 'Honor Roll Module Settings',
        'description' => 'Honor Roll CSV file path.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('honor_roll_admin'),
        'access arguments' => array('administer honor roll settings'),
        'type' => MENU_SUGGESTED_ITEM,
    );
    return $items;
}

/**
 * Implements hook_block_view().
 *
 * @return array    Contents and Subject.
 */
function honor_roll_block_view($delta = '')
{
    $modulePath = drupal_get_path('module', 'honor_roll');
    drupal_add_js($modulePath .'/js/main.js', array(
        'scope' => 'footer'
    ));
    
    // TODO: check to see if this is already available.
    drupal_add_js('https://code.jquery.com/ui/1.12.1/jquery-ui.js', array(
        'type' => 'external',
        'scope' => 'footer'
    ));
    switch ($delta) {
        case 'honor_roll_graduates':
            $block['subject'] = t('Honor Roll');
            $block['content'] = honor_roll_graduate_contents();
            break;
        case 'honor_roll_undergraduates':
            $block['subject'] = t('Honor Roll');
            $block['content'] = honor_roll_undergraduate_contents();
            break;
    }
    return $block;
}

/**
 * Create cache table for honor roll module.
 * 
 * @return array
 */
function honor_roll_flush_caches()
{
    return array(
        'honor_roll_cache',
    );
}

/**
 * Build the graduate honor roll element structure.
 *
 * @return html
 */
function honor_roll_graduate_contents()
{
    // Make sure the path has been set. Warn them if it is not.
    if (variable_get('honor_roll_graduate_csv_file_path') == null) {
        drupal_set_message(t('The CSV file path is not set. This needs to be set in the Graduate Honor Roll module settings.'), 'warning');
    }
    
    // Check cache here.
    if ($cached = cache_get('honor_roll_data', 'honor_roll_cache')) {
        $content = $cached->data;
    } else {
        $columnNames = array(
                'year'        => null,
                'firstName'   => null,
                'lastName'    => null,
                'memberLevel' => null
            );
        $HonorCSV = new HonorRoll\HonorRollCSV(variable_get('honor_roll_graduate_csv_file_path'), $columnNames);
        $content = honor_roll_html($HonorCSV->getArray());

        // Set cache
        cache_set('honor_roll_data', $content, $bin = 'honor_roll_cache', time() + 60*60); // Cache is set to 1 hour.
    }
    return $content;
}

/**
 * Build the undergraduate honor roll element structure.
 *
 * @return html
 */
function honor_roll_undergraduate_contents()
{
    // Make sure the path has been set. Warn them if it is not.
    if (variable_get('honor_roll_undergraduate_csv_file_path') == null) {
        drupal_set_message(t('The CSV file path is not set. This needs to be set in the Undergraduate Honor Roll module settings.'), 'warning');
    }
    
    // Check cache here.
    if ($cached = cache_get('undergrad_honor_roll_data', 'honor_roll_cache')) {
          $content = $cached->data;
    } else {
        $columnNames = array(
                'year'        => null,
                'firstName'   => null,
                'lastName'    => null,
                'memberLevel' => null
            );
        $UnderHonorCSV = new HonorRoll\HonorRollCSV(variable_get('honor_roll_undergraduate_csv_file_path'), $columnNames);
        $content = honor_roll_html($UnderHonorCSV->getArray());

        // Set cache
        cache_set('undergrad_honor_roll_data', $content, $bin = 'honor_roll_cache', time() + 60*60); // Cache is set to 1 hour.
    }
    return $content;
}

/**
 * Create the html accordions
 */
function honor_roll_html($arrayData)
{
    if (!$arrayData) {
        return;
    }

    $arrayYears = array();

    // Pull the years.
    foreach ($arrayData as $csvLine) {
        $arrayYears[] = $csvLine['year'];
    }
    $arrayYears = array_unique($arrayYears);

    $content = '<div id="accordion">';
    foreach ($arrayYears as $year) {
        $content .= '<h3>'.$year.'</h3>';
        $content .= '<div>
        <p>
        Mauris mauris ante, blandit et, ultrices a, suscipit eget, quam. Integer
        ut neque. Vivamus nisi metus, molestie vel, gravida in, condimentum sit
        amet, nunc. Nam a nibh. Donec suscipit eros. Nam mi. Proin viverra leo ut
        odio. Curabitur malesuada. Vestibulum a velit eu ante scelerisque vulputate.
        </p>
      </div>';
    }
    $content .= '</div>';
    return $content;
}
